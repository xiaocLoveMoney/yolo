# 训练性能优化说明

## 高性能模式

系统使用**高性能模式**，最大化 GPU 利用率，同时避免内存溢出。

### 核心优化

| 参数 | 设置 | 说明 |
|------|------|------|
| Batch Size | 自动 | 根据显存大小自动计算最佳值 |
| Workers | 8 | 平衡数据加载速度和内存使用 |
| Cache | disk | 磁盘缓存，加速数据加载，不占内存 |
| AMP | 启用 | 混合精度训练，节省显存，提升速度 |

### 自动 Batch Size

系统会根据 GPU 显存自动计算最佳 batch size：

| 显存 | 图片尺寸 416 | 图片尺寸 640 | 图片尺寸 1024 |
|------|-------------|-------------|---------------|
| 20GB+ (4090) | 64 | 32 | 16 |
| 10-20GB (5070/4080) | 48 | 24 | 12 |
| <10GB | 32 | 16 | 8 |

### 磁盘缓存 (cache: disk)

- **不占用内存**：数据缓存到磁盘，不会导致内存溢出
- **加速后续 epoch**：第一个 epoch 后，数据加载速度大幅提升
- **自动管理**：YOLOv8 自动管理缓存文件

### Workers = 8

- **提升数据加载速度**：8 个并行工作进程
- **不占用大量内存**：因为使用 disk 缓存，不需要预加载数据到内存
- **平衡点**：8 是性能和稳定性的良好平衡

## GPU 利用率提升

### 预期效果

| 优化项 | 提升效果 |
|--------|----------|
| 更大 Batch Size | GPU 利用率 +20-30% |
| Workers = 8 | 数据加载速度 +50% |
| Disk Cache | 后续 epoch 加载速度 +200% |
| AMP | 训练速度 +30-50%，显存节省 50% |

### 典型 GPU 利用率

- 优化前：~70%
- 优化后：~90-95%

## 使用说明

### 1. 默认设置（推荐）

- Batch Size：-1（自动）
- 系统会自动检测显存并计算最佳值

### 2. 手动调整

如果需要手动调整 batch size：

- **显存充足**：可以尝试更大的值（如 32、48、64）
- **显存不足**：减小到 16、12 或 8

### 3. 监控 GPU

训练时使用以下命令监控 GPU：

```bash
# Windows
nvidia-smi -l 1

# Linux
watch -n 1 nvidia-smi
```

## 训练日志示例

```
[2026-01-16T10:00:00] GPU: NVIDIA GeForce RTX 5070
[2026-01-16T10:00:00] GPU Memory: 12.0 GB
[2026-01-16T10:00:00] Auto batch size: 24 (based on 12.0GB VRAM)
[2026-01-16T10:00:00] Training settings (high-performance mode):
[2026-01-16T10:00:00]   - Batch size: 24
[2026-01-16T10:00:00]   - Workers: 8
[2026-01-16T10:00:00]   - AMP (Mixed Precision): True
[2026-01-16T10:00:00]   - Cache: disk (disk-based, memory-safe)
[2026-01-16T10:00:00]   - Cosine LR: True
```

## 故障排查

### 显存溢出（GPU OOM）

症状：CUDA out of memory 错误

解决方案：
1. 减小 batch size（如从 24 改为 16）
2. 减小图片尺寸（如从 640 改为 416）

### 内存溢出（RAM OOM）

症状：系统内存不足

解决方案：
1. 减少 workers（修改 train_script.py 中的 workers = 4）
2. 确认使用的是 disk 缓存而不是 ram 缓存

### GPU 利用率仍然较低

可能原因：
1. **数据集太小**：小数据集可能无法充分利用 GPU
2. **磁盘速度慢**：使用 SSD 替代 HDD
3. **Batch Size 太小**：尝试增加 batch size

## 高级优化（可选）

如果需要进一步优化，可以修改 `backend/src/yolo/train_script.py`：

### 增加 Workers

```python
workers = 12  # 从 8 增加到 12
```

### 使用 RAM 缓存（大内存用户）

```python
use_cache = "ram"  # 如果内存 > 128GB 可以考虑
```

### 启用多尺度训练

```python
"multi_scale": True,  # 可能提升精度，但会降低速度
```

## 总结

高性能模式优化：

✅ **自动 Batch Size**（根据显存自动计算）  
✅ **Workers = 8**（平衡速度和稳定性）  
✅ **Disk Cache**（加速数据加载，不占内存）  
✅ **AMP**（混合精度，节省显存，提升速度）  
✅ **Cosine LR**（余弦学习率调度，提升训练效果）

预期 GPU 利用率：90-95%
